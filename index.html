<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Targowisko Klanowe - Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold-start: #ffd700;
            --gold-end: #b8860b;
            --bg: #0a0a0a;
            --card-bg: rgba(30, 30, 30, 0.8);
            --green: #2ecc71; --blue: #3498db; --red: #e74c3c;
            --purple: #9b59b6;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 215, 0, 0.2);
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg);
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(255, 215, 0, 0.03) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(155, 89, 182, 0.03) 0%, transparent 25%);
            color: #eee;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }

        .container { max-width: 1200px; margin: 0 auto; position: relative; z-index: 1; }

        /* HEADER */
        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 30px;
            flex-wrap: wrap; gap: 15px;
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
            padding: 20px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        h1 { 
            font-family: 'MedievalSharp', cursive; 
            background: linear-gradient(to bottom, var(--gold-start), var(--gold-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0; font-size: 2.2em; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            letter-spacing: 1px;
        }

        /* LOGOWANIE */
        .login-btn {
            background: linear-gradient(135deg, #ffffff, #e0e0e0);
            color: #333; border: none; padding: 10px 25px;
            border-radius: 30px; cursor: pointer; font-weight: bold; 
            display: flex; align-items: center; gap: 10px; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255,255,255,0.1);
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,255,255,0.2); }

        .user-profile { display: none; align-items: center; gap: 15px; }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--gold-start); box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        .logout-link { color: #888; font-size: 0.8em; cursor: pointer; transition: 0.3s; }
        .logout-link:hover { color: var(--red); text-decoration: underline; }

        /* FILTRY */
        .filters { display: flex; gap: 10px; margin-bottom: 30px; justify-content: center; flex-wrap: wrap; }
        .filter-btn {
            background: rgba(255,255,255,0.05); color: #aaa; border: 1px solid rgba(255,255,255,0.1); 
            padding: 8px 20px; border-radius: 20px; cursor: pointer; transition: 0.3s; font-size: 0.9em; font-weight: 500;
        }
        .filter-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .filter-btn.active { 
            background: linear-gradient(135deg, var(--gold-start), var(--gold-end)); 
            color: #000; border-color: transparent; font-weight: bold; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        /* FORMULARZ (GLASSMORPHISM) */
        .panel {
            background: var(--card-bg); 
            backdrop-filter: blur(10px);
            padding: 25px; border-radius: 15px; border: 1px solid var(--border);
            margin-bottom: 40px; display: none; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: 1 / -1; }

        input, select, textarea {
            background: rgba(0,0,0,0.6); border: 1px solid #333; color: #fff;
            padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box;
            transition: 0.3s; font-family: 'Montserrat', sans-serif;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--gold-start); outline: none;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.1);
        }
        
        select { color: var(--gold-start); cursor: pointer; }
        option { background: #000; color: #fff; padding: 5px; }

        #itemSelect { border-color: var(--gold-start); display: none; background: rgba(20, 15, 0, 0.9); }

        .action-btn {
            background: linear-gradient(135deg, var(--gold-start), var(--gold-end));
            color: #000; border: none; padding: 14px;
            font-weight: bold; width: 100%; cursor: pointer; border-radius: 8px;
            transition: 0.3s; font-size: 1em; letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4); }

        .helper-btn { 
            background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); 
            padding: 10px; cursor: pointer; border-radius: 8px; white-space: nowrap; transition: 0.3s; 
        }
        .helper-btn:hover { background: rgba(255,255,255,0.2); }

        /* LIVE PREVIEW BOX */
        .preview-box {
            grid-column: 1 / -1; display: none; align-items: center; gap: 15px;
            background: linear-gradient(to right, rgba(255, 215, 0, 0.1), transparent);
            border-left: 4px solid var(--gold-start);
            padding: 15px; border-radius: 4px; margin-bottom: 10px;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn { from { opacity:0; transform:translateY(-5px); } to { opacity:1; transform:translateY(0); } }
        
        .preview-box img {
            width: 48px; height: 48px; border: 1px solid #444; background: #000; border-radius: 6px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .preview-text { font-size: 1.1em; color: var(--gold-start); font-weight: bold; }
        .preview-label { font-size: 0.7em; color: #888; text-transform: uppercase; display: block; margin-bottom: 2px; letter-spacing: 1px; }

        /* LISTA OFERT */
        .offers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }

        /* Styl Legendarny Karty */
        .offer-card {
            background: var(--card-bg); 
            border: 1px solid transparent; 
            border-radius: 12px; padding: 20px; position: relative; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            /* Legendarny styl domy≈õlny */
            background-image: linear-gradient(#1e1e1e, #1e1e1e), linear-gradient(135deg, var(--gold-start), #2a2105);
            background-origin: border-box;
            background-clip: content-box, border-box;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .offer-card:hover { 
            transform: translateY(-7px) scale(1.01); 
            box-shadow: 0 15px 30px rgba(255, 215, 0, 0.15); 
        }

        .tag { 
            display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.7em; 
            font-weight: 700; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .tag.sprzedam { background: rgba(46, 204, 113, 0.15); color: var(--green); border: 1px solid rgba(46, 204, 113, 0.3); }
        .tag.kupie { background: rgba(52, 152, 219, 0.15); color: var(--blue); border: 1px solid rgba(52, 152, 219, 0.3); }
        .tag.zamienie { background: rgba(231, 76, 60, 0.15); color: var(--red); border: 1px solid rgba(231, 76, 60, 0.3); }

        .item-img { width: 64px; height: 64px; float: right; object-fit: contain; filter: drop-shadow(0 0 5px rgba(0,0,0,0.7)); transition: 0.3s; }
        .offer-card:hover .item-img { transform: scale(1.1) rotate(5deg); }
        
        .item-source { 
            font-size: 0.85em; color: #d1a3ff; margin-bottom: 15px; font-weight: 600; 
            display: flex; align-items: center; gap: 10px; background: rgba(155, 89, 182, 0.1);
            padding: 8px; border-radius: 6px; border: 1px solid rgba(155, 89, 182, 0.2);
        }
        .item-source img { height: 35px; width: auto; object-fit: contain; }

        .margo-link {
            display: inline-block; font-size: 0.8em; color: var(--blue); text-decoration: none; 
            border: 1px solid var(--blue); padding: 4px 10px; border-radius: 4px; margin-bottom: 12px; transition: 0.3s;
        }
        .margo-link:hover { background: var(--blue); color: #fff; }

        .seller-info { 
            margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); 
            display: flex; align-items: center; justify-content: space-between; font-size: 0.85em; color: #aaa;
        }
        .seller-left { display: flex; align-items: center; gap: 10px; }
        .tiny-avatar { width: 28px; height: 28px; border-radius: 50%; }

        .copy-nick-btn { 
            background: none; border: 1px solid #555; color: #888; cursor: pointer; 
            padding: 3px 8px; border-radius: 4px; font-size: 0.8em; transition: 0.2s;
        }
        .copy-nick-btn:hover { color: var(--gold-start); border-color: var(--gold-start); background: rgba(255,215,0,0.1); }

        .time-ago { font-size: 0.75em; color: #666; font-style: italic; }
        
        .delete-btn {
            position: absolute; top: 15px; right: 15px;
            background: rgba(231, 76, 60, 0.1); color: var(--red); border: 1px solid var(--red);
            cursor: pointer; font-size: 0.8em; padding: 4px 8px; border-radius: 4px; transition: 0.2s;
        }
        .delete-btn:hover { background: var(--red); color: #fff; }

        /* TOAST NOTIFICATION */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 50px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px;
            transform: translateX(-50%); font-size: 17px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 1px solid var(--gold-start); opacity: 0; transition: opacity 0.5s, bottom 0.5s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>‚öîÔ∏è Targowisko (Legendy)</h1>
        <button id="googleLoginBtn" class="login-btn">
            <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
            Zaloguj
        </button>

        <div id="userProfile" class="user-profile">
            <img id="userAvatar" class="user-avatar" src="" alt="">
            <div>
                <div id="userNickDisplay" style="font-weight:bold; color:var(--gold-start)">...</div>
                <div class="logout-link" onclick="logout()">Wyloguj</div>
            </div>
        </div>
    </header>

    <div class="filters">
        <button class="filter-btn active" onclick="filterOffers('all')">Wszystkie</button>
        <button class="filter-btn" onclick="filterOffers('sprzedam')">Sprzedam</button>
        <button class="filter-btn" onclick="filterOffers('kupie')">Kupiƒô</button>
        <button class="filter-btn" onclick="filterOffers('zamienie')">Zamieniƒô</button>
    </div>

    <div id="addOfferPanel" class="panel">
        <h3 style="margin-top:0; color:var(--gold-start); border-bottom:1px solid #333; padding-bottom:10px;">Dodaj Legendarne Og≈Çoszenie</h3>
        
        <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; margin-bottom:20px; border:1px dashed var(--gold-start);">
            <div style="font-size:0.85em; color:var(--gold-start); margin-bottom:8px; font-weight:bold;">‚ö° Opcja Szybka: Wklej kod z forum</div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="pasteCode" placeholder='<img src="..." stats="...">'>
                <button class="action-btn" onclick="parseItemCode()" style="width:auto; font-size:0.9em;">Wczytaj</button>
            </div>
        </div>

        <div class="form-grid">
            <select id="offerType">
                <option value="sprzedam">Sprzedam</option>
                <option value="kupie">Kupiƒô</option>
                <option value="zamienie">Zamieniƒô</option>
            </select>
            <input type="text" id="itemPrice" placeholder="Cena (np. 50m)">
            
            <select id="itemSource" class="full-width" onchange="updateLootList()">
                <option value="">-- Wybierz Herosa/Tytana (Pe≈Çna Baza Legend) --</option>
            </select>

            <select id="itemSelect" class="full-width" onchange="fillItemDetails()">
                <option value="">-- Wybierz przedmiot legendarny --</option>
            </select>

            <div id="livePreview" class="preview-box">
                <img id="previewIcon" src="" alt="Ikona">
                <div>
                    <span class="preview-label">Wybrano:</span>
                    <span id="previewName" class="preview-text">...</span>
                </div>
            </div>

            <div style="display:flex; gap:10px; align-items:center;" class="full-width">
                <input type="text" id="itemName" placeholder="Nazwa przedmiotu" style="margin:0;">
                <button class="helper-btn" onclick="searchMargo()" title="Szukaj na MargoWorld">üîç</button>
            </div>

            <input type="text" id="itemMargoLink" placeholder="Link do statystyk (opcjonalne)" class="full-width">
            <input type="text" id="itemImg" placeholder="Link do obrazka" class="full-width">
            <textarea id="itemDesc" placeholder="Opis przedmiotu (automatyczny lub w≈Çasny)" class="full-width"></textarea>
            
            <button class="action-btn full-width" onclick="addOffer()">OPUBLIKUJ OFERTƒò</button>
        </div>
    </div>

    <div id="offersList" class="offers-grid">
        <div style="text-align:center; grid-column:1/-1; color:#666;">≈Åadowanie ofert...</div>
    </div>
</div>

<div id="toast">Powiadomienie</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    
    // --- ‚ö†Ô∏è WKLEJ TU SWOJƒÑ KONFIGURACJƒò ‚ö†Ô∏è ---
    const firebaseConfig = {
      apiKey: "AIzaSyApFYFkAghXreeX_xptg-PTCSxtPdiXYdA",
      authDomain: "targowisko-klanu.firebaseapp.com",
      projectId: "targowisko-klanu",
      storageBucket: "targowisko-klanu.firebasestorage.app",
      messagingSenderId: "1002027435908",
      appId: "1:1002027435908:web:56419c7bc38e148cf0ffd1"
    };
    // ------------------------------------------

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let currentNick = null;
    let allOffers = [];
    let currentFilter = 'all';

    function showToast(msg) {
        const x = document.getElementById("toast");
        x.innerText = msg;
        x.className = "show";
        setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
    }

    // --- BAZA HEROS√ìW ---
    const monstersList = [
        { name: "Domina Ecclesiae (21 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/domina.gif" },
        { name: "Mietek ≈ªul (25 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/mas/mietek_zul.gif" },
        { name: "Mroczny Patryk (35 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/bardzozlypatryk.gif" },
        { name: "Karmazynowy M≈õciciel (45 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/klanowe/heros_karm_msc.gif" },
        { name: "Z≈Çodziej (51 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/zlodziej.gif" },
        { name: "Z≈Çy Przewodnik (63 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/mnich-zly2.gif" },
        { name: "Opƒôtany Paladyn (74 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/opetanypaladyn02.gif" },
        { name: "Piekielny Ko≈õciej (85 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/piekielny_kosciej.gif" },
        { name: "Koziec MƒÖciciel ≈öcie≈ºek (94lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/koziec_maciciel_sciezek.gif" },
        { name: "Kochanka Nocy (102 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/kochanka-nocy.gif" },
        { name: "KsiƒÖ≈ºƒô Kasim (116 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/ksiaze-kasim.gif" },
        { name: "≈öwiƒôty Braciszek (123 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/sw_braciszek.gif" },
        { name: "Z≈Çoty Roger (135 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/szkielet_pirata.gif" },
        { name: "Baca bez ≈Çowiec (144 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/baca-bez-lowiec.gif" },
        { name: "CzarujƒÖca Atalia (157 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/czarujaca-atalia.gif" },
        { name: "Ob≈ÇƒÖkany ≈Åowca Ork√≥w (165 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/oblakany_ac1dae9d.gif" },
        { name: "Lichwiarz Grauhaz (177 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/lichwiarz_grauhaz.gif" },
        { name: "Viviana Nandin (185 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/viv_nandin_i3bd1.gif" },
        { name: "Przeraza (194 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/przeraza.gif" },
        { name: "Demonis Pan Nico≈õci (205 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/sekta_demon_cz_s.gif" },
        { name: "Mulher Ma (214 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/mulher_ma.gif" },
        { name: "Vapor Veneno (231 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/joziniec_bagienny.gif" },
        { name: "Dƒôboro≈ºec (244 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/zwierz_kniei.gif" },
        { name: "Tepeyollotl (258 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/tep_35ecb966.gif" },
        { name: "Widmo Triady (265 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/trist2_widmo_triady.gif" },
        { name: "Negthotep Czarny Kap≈Çan (271 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/negthotep.gif" },
        { name: "M≈Çody Smok (282 lvl)", img: "https://micc.garmory-cdn.cloud/obrazki/npc/her/smokbarb.gif" }
    ];

    // --- PE≈ÅNA BAZA LEGEND Z PLIKU (UZUPE≈ÅNIONA) ---
    const lootTable = {
        "Domina Ecclesiae (21 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/sur/smocza_runa3.gif", stats: "Smocza Runa (Legenda)||rarity=legendary;runes=2250"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Lekka skrytka mocy||rarity=legendary"},
            {img: "", stats: "Legendarny Przedmiot 3 (Brak w pliku)||rarity=legendary"},
            {img: "", stats: "Legendarny Przedmiot 4 (Brak w pliku)||rarity=legendary"}
        ],
        "Mietek ≈ªul (25 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Lekka skrytka mocy||rarity=legendary"},
            {img: "", stats: "Legendarny Przedmiot 2 (Brak w pliku)||rarity=legendary"},
            {img: "", stats: "Legendarny Przedmiot 3 (Brak w pliku)||rarity=legendary"},
            {img: "", stats: "Legendarny Przedmiot 4 (Brak w pliku)||rarity=legendary"}
        ],
        "Mroczny Patryk (35 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm749.gif", stats: "Kapelusz wiecznej udrƒôki||rarity=legendary;opis=Chocia≈º poprzednia w≈Ça≈õcicielka tego kapelusza powiƒÖzana by≈Ça z ciemnƒÖ stronƒÖ mocy..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm748.gif", stats: "Splot szale≈Ñstwa||rarity=legendary;opis=Ostre kolce bole≈õnie wbija≈Çy siƒô w skro≈Ñ..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm1365.gif", stats: "Korona ta≈ÑczƒÖcych p≈Çomieni||rarity=legendary;opis=P≈ÇonƒÖca wiecznie czarnym ogniem korona..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Lekka skrytka mocy||rarity=legendary"}
        ],
        "Karmazynowy M≈õciciel (45 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice854.gif", stats: "Stalowe szpony zemsty||rarity=legendary;opis=Zmechanizowane rƒôkawice wykradzione z tajemnego schowka gnom√≥w."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice853.gif", stats: "Chwyt niestygnƒÖcej krwi||rarity=legendary;opis=Krew plamiƒÖca rƒôkawice nie mia≈Ça czasu zaschnƒÖƒá..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice855.gif", stats: "Kajdany gniewnej tu≈Çaczki||rarity=legendary;opis=Gdy M≈õciciel opuszcza≈Ç sw√≥j dom, zabra≈Ç ze sobƒÖ ciƒô≈ºkie kajdany..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Lekka skrytka mocy||rarity=legendary"}
        ],
        "Z≈Çodziej (51 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/but/buty535.gif", stats: "Pantofle Madame Baterflaj||rarity=legendary;opis=Jedna z pamiƒÖtek skradzionych w Eder."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/but/buty872.gif", stats: "Podw√≥jne podeszwy z≈Çodzieja||rarity=legendary;opis=W ka≈ºdym bucie znajduje siƒô ma≈Ça skrytka."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/but/buty871.gif", stats: "PamiƒÖtka z Tuzmer||rarity=legendary;opis=Nagroda po≈õwiadczajƒÖca uko≈Ñczenie szkolenia."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Lekka skrytka mocy||rarity=legendary"}
        ],
        "Z≈Çy Przewodnik (63 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice893.gif", stats: "Dwulicowy chwyt mnicha||rarity=legendary;opis=Ciƒô≈ºkie, szmaragdowe szaty przywdziane po rozmowie z opatem."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice891.gif", stats: "Dotyk zwodniczych mgie≈Ç||rarity=legendary;opis=Zielone mankiety sporadycznie znikajƒÖ tak jak przewodnik..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice892.gif", stats: "Zamach wybitnego ≈Çgarza||rarity=legendary;opis=Rƒôkawiczki te wskaza≈Çy z≈ÇƒÖ drogƒô wielu ≈õmia≈Çkom..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Lekka skrytka mocy||rarity=legendary"}
        ],
        "Opƒôtany Paladyn (74 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm847.gif", stats: "Zƒôby klasztornego postrachu||rarity=legendary;opis=≈ªelazne podeszwy stukajƒÖce o klasztorne posadzki zwiastowa≈Çy tylko jedno..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm845.gif", stats: "Z≈Çota maska opƒôta≈Ñca||rarity=legendary;opis=Chocia≈º w z≈Çotej masce szala≈Çy rozpalone oczodo≈Çy..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm846.gif", stats: "Przy≈Çbica przeklƒôtego umys≈Çu||rarity=legendary;opis=Zdobiony kask przypomina o klƒÖtwie trawiƒÖcej duszƒô Markusa Vinta."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Lekka skrytka mocy||rarity=legendary"}
        ],
        "Piekielny Ko≈õciej (85 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik918.gif", stats: "CzƒÖstka si≈Çy Azelatho||rarity=legendary;opis=Przemieniony w ko≈õcieja Tervil rzuci≈Ç siƒô na Morthena..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik920.gif", stats: "PamiƒÖtka poprzedniego ≈ºycia||rarity=legendary;opis=Za ≈ºycia dow√≥dca itha≈Ñskiego oddzia≈Çu..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik919.gif", stats: "Manifestacja mocy Shurako||rarity=legendary;opis=S≈Çowa Tervila da≈Çy do my≈õlenia Morthenowi..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Lekka skrytka mocy||rarity=legendary"}
        ],
        "Koziec MƒÖciciel ≈öcie≈ºek (94lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/sur/koziec_craft_02.gif", stats: "Kwiecista narzuta Ko≈∫ca||rarity=legendary;opis=Gƒôsty splot le≈õnych pnƒÖczy, w kontakcie z magiƒÖ Ko≈∫ca..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/sur/koziec_craft_03.gif", stats: "Trzeci r√≥g mƒÖciciela||rarity=legendary;opis=WyjƒÖtkowe trofeum czy bezu≈ºyteczna pamiƒÖtka?"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/sur/koziec_craft_01.gif", stats: "Bukiet kryszta≈Çowych bazi||rarity=legendary;opis=Dr≈ºyjcie stare wierzby i pogrƒÖ≈ºcie siƒô w strachu..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Lekka skrytka mocy||rarity=legendary"}
        ],
        "Kochanka Nocy (102 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm851.gif", stats: "Oblicze smutku||rarity=legendary;opis=Gdy poziom smutku przekracza pewnƒÖ granicƒô..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm853.gif", stats: "He≈Çm kochanka Nocnej Kochanki||rarity=legendary;opis=He≈Çm ten to jedna z niewielu pamiƒÖtek..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm852.gif", stats: "Maska nocnego szlochu||rarity=legendary;opis=Wielkie emocje targajƒÖce wdowƒÖ uwolni≈Çy w jej umy≈õle pok≈Çady magii."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Skrytka mocy||rarity=legendary"}
        ],
        "KsiƒÖ≈ºƒô Kasim (116 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice1010.gif", stats: "KlƒÖtwa tysiƒÖca i jednej nocy||rarity=legendary;opis=Przeklƒôty amulet Abrizy - ukochanej Kasima..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice1009.gif", stats: "Szpony utraconej nadziei||rarity=legendary;opis=Wizja skarbu, kt√≥ry odmieniƒá mia≈Ç ≈ºycie m≈Çodego ksiƒôcia..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice1011.gif", stats: "Rƒôkawy z pustynnych krain||rarity=legendary;opis=Trudne ≈ºycie tworzy twardych ludzi..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Skrytka mocy||rarity=legendary"}
        ],
        "≈öwiƒôty Braciszek (123 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1133.gif", stats: "Medalion smakosza trunk√≥w||rarity=legendary;opis=Umys≈Çy oczyszcza woda ≈õwiƒôcona..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1135.gif", stats: "Tabernakulum z sekretnƒÖ recepturƒÖ||rarity=legendary;opis=WewnƒÖtrz wisiorka malutka ksiƒÖ≈ºeczka..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1134.gif", stats: "Krzy≈º wiary w trunki (Szacowany)||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Skrytka mocy||rarity=legendary"}
        ],
        "Z≈Çoty Roger (135 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice1189.gif", stats: "Z≈Çowrogie czaszki Rogera||rarity=legendary;opis=Gdy za≈Çoga zacumowa≈Ça w ukrytym porcie..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice1188.gif", stats: "Pirackie rƒôkawice (Szacowany)||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice1190.gif", stats: "Skrab kapitana (Szacowany)||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Skrytka mocy||rarity=legendary"}
        ],
        "Baca bez ≈Çowiec (144 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1163.gif", stats: "Serowe wahade≈Çko||rarity=heroic"}, 
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1164.gif", stats: "Sztuczka do≈õwiadczonego bacy||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1162.gif", stats: "Eteryczny baran||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Skrytka mocy||rarity=legendary"}
        ],
        "CzarujƒÖca Atalia (157 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/pie/pierscien1196.gif", stats: "Otok rodzinnych niesnasek||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/pie/pierscien1197.gif", stats: "PamiƒÖtka rodu czarownic||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/pie/pierscien1195.gif", stats: "Po≈ºeracz zmarszczek||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Skrytka mocy||rarity=legendary"}
        ],
        "Ob≈ÇƒÖkany ≈Åowca Ork√≥w (165 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice1211.gif", stats: "Stalowa piƒô≈õƒá ob≈ÇƒÖka≈Ñca||rarity=legendary;opis=Splamienie odzienia, a tym bardziej w≈Çasnego cia≈Ça..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice1213.gif", stats: "Mankiety z zerwanych sztandar√≥w||rarity=legendary;opis=Krwawa rze≈∫ dokonana przez ork√≥w..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice1212.gif", stats: "Mia≈ºd≈ºyciele orczych serc||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Skrytka mocy||rarity=legendary"}
        ],
        "Lichwiarz Grauhaz (177 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1165.gif", stats: "Sopel z porzuconych kopalni||rarity=legendary;opis=PamiƒÖtka z ambitnej ekspedycji w g≈Çƒôbie krainy mrozu..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1167.gif", stats: "Kolia dumnego rodu||rarity=legendary;opis=Podobno lichwiarz z Kardar-dun pochodzi≈Ç z klanu s≈ÇynƒÖcego z takiej buty..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1166.gif", stats: "Klejnot smoczej choroby||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Skrytka mocy||rarity=legendary"}
        ],
        "Viviana Nandin (185 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm627.gif", stats: "Eteryczny wieniec Viviany||rarity=legendary;opis=Szczera ≈Çza Viviany sp≈Çynƒô≈Ça na poro≈ºe jej martwego wierzchowca..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm627.gif", stats: "Eteryczny wieniec Viviany||rarity=legendary"},
            {img: "", stats: "Legendarny Przedmiot 3 (Brak danych)||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Skrytka mocy||rarity=legendary"}
        ],
        "Przeraza (194 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice1371.gif", stats: "Bransolety kwitnƒÖcej aberracji||rarity=legendary;opis=Przeraza nie posiada w≈Çasnej osobowo≈õci - przemawiajƒÖ przez niƒÖ ofiary..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice1370.gif", stats: "D≈Çonie wielu osobowo≈õci||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice1372.gif", stats: "Mankiety powiernika woli||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Skrytka mocy||rarity=legendary"}
        ],
        "Demonis Pan Nico≈õci (205 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/pie/pierscien1284.gif", stats: "Czarne S≈Ço≈Ñce||rarity=legendary;opis=Wojna Mag√≥w nadesz≈Ça i przeminƒô≈Ça..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/pie/pierscien1285.gif", stats: "Krwawa relikwia||rarity=legendary;opis=W czasach, gdy Nithal by≈Ço zaledwie ma≈ÇƒÖ osadƒÖ..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/pie/pierscien1286.gif", stats: "Nerw wzrokowy demona||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Ciƒô≈ºka skrytka mocy||rarity=legendary"}
        ],
        "Mulher Ma (214 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Ciƒô≈ºka skrytka mocy||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1300.gif", stats: "Ko≈Çnierz dekapitacji||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1299.gif", stats: "Obrƒôcz Najwy≈ºszej Kap≈Çanki||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1301.gif", stats: "Wdziƒôczno≈õƒá Pajƒôczycy||rarity=legendary"}
        ],
        "Vapor Veneno (231 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Ciƒô≈ºka skrytka mocy||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/pie/pierscien1319.gif", stats: "B≈Çyskotka humanoidalnej natury||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/pie/pierscien1320.gif", stats: "Pier≈õcionek toksycznej fascynacji||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/pie/pierscien1318.gif", stats: "Symbol wodnych narodzin||rarity=legendary"}
        ],
        "Dƒôboro≈ºec (244 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm1487.gif", stats: "Czaszka wielkiego nieszczƒô≈õnika||rarity=legendary;opis=Trofeum z potƒô≈ºnego stra≈ºnika lasu."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm1488.gif", stats: "Gniew stra≈ºnika kniei||rarity=legendary;opis=Maska u≈ºywana podczas rytua≈Ç√≥w..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm1489.gif", stats: "Maska Puryfikacji||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Ciƒô≈ºka skrytka mocy||rarity=legendary"}
        ],
        "Tepeyollotl (258 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1358.gif", stats: "Brama do za≈õwiat√≥w||rarity=legendary;opis=Potƒô≈ºny pancerz wykonany z najtwardszych sk√≥r..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1357.gif", stats: "Krƒôgos≈Çupy boskich bli≈∫niƒÖt||rarity=legendary;opis=≈öwiat zosta≈Ç ju≈º zniszczony cztery razy..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/nas/naszyjnik1356.gif", stats: "Symbol Wieczno≈õci||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Ciƒô≈ºka skrytka mocy||rarity=legendary"}
        ],
        "Widmo Triady (265 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm1501.gif", stats: "Kaptur wyzwolenia ducha||rarity=legendary;opis=Zbroja, kt√≥ra zdaje siƒô znikaƒá w cieniu..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm1502.gif", stats: "Ofiara eliksiru hydrofilowego||rarity=legendary;opis=Wƒôdr√≥wka przez dziewiƒôƒá krƒôg√≥w Mictlan..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm1503.gif", stats: "Przeklƒôta klatka na ptaki||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Ciƒô≈ºka skrytka mocy||rarity=legendary"}
        ],
        "Negthotep Czarny Kap≈Çan (271 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice521.gif", stats: "Palce demonicznego kompozytora||rarity=legendary;opis=Wieki temu, nim w krainie zaistnia≈Çy pierwsze antyczne cywilizacje..."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice520.gif", stats: "D≈Çonie Czarnego Kap≈Çana||rarity=legendary;opis=Kto za≈Ço≈ºy tƒô maskƒô, staje siƒô jedno≈õciƒÖ z mrokiem."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/rek/rekawice519.gif", stats: "Z≈Çoty chwyt genera≈Ça||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Ciƒô≈ºka skrytka mocy||rarity=legendary"}
        ],
        "M≈Çody Smok (282 lvl)": [
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/tal/tal32.gif", stats: "Talizman smoczego boga||rarity=legendary;opis=He≈Çm wykuty w smoczym ogniu."},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm658.gif", stats: "Maska gniewu Shaiharrud||rarity=legendary"}, 
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm659.gif", stats: "Skupisko smoczej magii||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/hel/helm657.gif", stats: "Wiƒôzienie gadzich p≈Çomieni||rarity=legendary"},
            {img: "https://micc.garmory-cdn.cloud/obrazki/itemy/bag/kuf_compontent_06.gif", stats: "Ciƒô≈ºka skrytka mocy||rarity=legendary"}
        ]
    };

    // ≈Åadowanie listy heros√≥w do selecta
    const sourceSelect = document.getElementById('itemSource');
    monstersList.forEach(mob => {
        let opt = document.createElement('option');
        opt.value = mob.name; 
        opt.dataset.img = mob.img; 
        opt.innerText = mob.name;
        sourceSelect.appendChild(opt);
    });

    // Parser kodu (wklejanie)
    window.parseItemCode = function() {
        const raw = document.getElementById('pasteCode').value;
        if (!raw) return showToast("Wklej kod przedmiotu!");
        const imgMatch = raw.match(/src="([^"]+)"/);
        if (imgMatch) document.getElementById('itemImg').value = imgMatch[1];
        const statsMatch = raw.match(/stats="([^"|]+)/);
        if (statsMatch) document.getElementById('itemName').value = statsMatch[1];
        const opisMatch = raw.match(/opis=([^;"]+)/);
        if (opisMatch) {
            document.getElementById('itemDesc').value = opisMatch[1].replace(/\[br\]/g, "\n");
        } else {
            document.getElementById('itemDesc').value = "";
        }
        showToast("Dane wczytane!");
    }

    // Wyb√≥r herosa - ≈Çadowanie listy przedmiot√≥w
    window.updateLootList = function() {
        const heroName = document.getElementById('itemSource').value;
        const itemSelect = document.getElementById('itemSelect');
        itemSelect.innerHTML = '<option value="">-- Wybierz przedmiot legendarny --</option>'; 
        
        if (heroName && lootTable[heroName] && lootTable[heroName].length > 0) {
            itemSelect.style.display = 'block'; 
            lootTable[heroName].forEach(item => {
                const realName = item.stats.split('||')[0];
                let opt = document.createElement('option');
                opt.value = JSON.stringify(item); 
                opt.innerText = realName;
                itemSelect.appendChild(opt);
            });
        } else {
            itemSelect.style.display = 'none'; 
            if(heroName) showToast("Brak legend w bazie dla tego herosa.");
        }
    }

    // Uzupe≈Çnienie formularza po wyborze przedmiotu
    window.fillItemDetails = function() {
        const selectedValue = document.getElementById('itemSelect').value;
        if (!selectedValue) return;

        const itemData = JSON.parse(selectedValue);
        const namePart = itemData.stats.split('||')[0];
        const statsPart = itemData.stats.split('||')[1] || "";

        document.getElementById('itemName').value = namePart;
        document.getElementById('itemImg').value = itemData.img;

        // --- AKTUALIZACJA LIVE PREVIEW ---
        const previewBox = document.getElementById('livePreview');
        const previewImg = document.getElementById('previewIcon');
        const previewTxt = document.getElementById('previewName');

        if (itemData.img) {
            previewBox.style.display = 'flex';
            previewImg.src = itemData.img;
            previewTxt.innerText = namePart;
        }
        // ---------------------------------

        let description = "";
        if (statsPart.includes('opis=')) {
            const parts = statsPart.split(';');
            for (let p of parts) {
                if (p.startsWith('opis=')) {
                    description = p.replace('opis=', '').replaceAll('[br]', '\n');
                    break;
                }
            }
        }
        document.getElementById('itemDesc').value = description;
    }

    document.getElementById('googleLoginBtn').addEventListener('click', () => {
        signInWithPopup(auth, provider).catch(e => showToast(e.message));
    });

    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (user) {
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                currentNick = userSnap.data().nick;
            } else {
                let nick = prompt("Podaj sw√≥j nick z Margonem:");
                if(nick && nick.trim()) {
                    currentNick = nick.trim();
                    await setDoc(userRef, { nick: currentNick, email: user.email, photo: user.photoURL });
                } else {
                    logout(); return;
                }
            }
            document.getElementById('googleLoginBtn').style.display = 'none';
            document.getElementById('userProfile').style.display = 'flex';
            document.getElementById('addOfferPanel').style.display = 'block';
            document.getElementById('userNickDisplay').innerText = currentNick;
            document.getElementById('userAvatar').src = user.photoURL;
        } else {
            document.getElementById('googleLoginBtn').style.display = 'flex';
            document.getElementById('userProfile').style.display = 'none';
            document.getElementById('addOfferPanel').style.display = 'none';
            currentNick = null;
        }
        renderOffers();
    });

    window.searchMargo = () => {
        const name = document.getElementById('itemName').value;
        if(!name) return showToast("Wpisz nazwƒô przedmiotu!");
        window.open(`https://margoworld.pl/ladder/item?name=${encodeURIComponent(name)}`, '_blank');
    };

    window.addOffer = async () => {
        if (!currentUser || !currentNick) return showToast("Musisz siƒô zalogowaƒá!");
        
        const type = document.getElementById('offerType').value;
        const name = document.getElementById('itemName').value;
        const price = document.getElementById('itemPrice').value;
        const margoLink = document.getElementById('itemMargoLink').value;
        const desc = document.getElementById('itemDesc').value;
        const img = document.getElementById('itemImg').value;

        const sel = document.getElementById('itemSource');
        const sourceName = sel.value; 
        const sourceImg = sel.selectedIndex > 0 ? sel.options[sel.selectedIndex].dataset.img : "";

        if(!name || !price) return showToast("Uzupe≈Çnij nazwƒô i cenƒô!");

        try {
            await addDoc(collection(db, "oferty"), {
                userId: currentUser.uid, nick: currentNick, avatar: currentUser.photoURL,
                type, name, price, source: sourceName, sourceImg: sourceImg, margoLink, desc, img,
                date: new Date().toISOString()
            });
            document.getElementById('itemName').value = "";
            document.getElementById('itemPrice').value = "";
            document.getElementById('itemSource').value = "";
            document.getElementById('itemSelect').style.display = 'none';
            document.getElementById('livePreview').style.display = 'none';
            document.getElementById('itemMargoLink').value = "";
            document.getElementById('itemDesc').value = "";
            document.getElementById('itemImg').value = "";
            showToast("Og≈Çoszenie dodane!");
        } catch(e) { showToast("B≈ÇƒÖd: " + e.message); }
    };

    window.deleteOffer = async (id) => {
        if(confirm("Czy na pewno chcesz usunƒÖƒá to og≈Çoszenie?")) {
            await deleteDoc(doc(db, "oferty", id));
            showToast("Usuniƒôto!");
        }
    };

    window.copyNick = (nick) => {
        navigator.clipboard.writeText(`/t ${nick} `).then(() => showToast(`Skopiowano: /t ${nick}`));
    };

    function timeSince(dateString) {
        if(!dateString) return "";
        const date = new Date(dateString);
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " dni temu";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " godz. temu";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " min. temu";
        return "teraz";
    }

    window.filterOffers = (filterType) => {
        currentFilter = filterType;
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.innerText.toLowerCase() === filterType || (filterType === 'all' && btn.innerText === 'Wszystkie')) {
                btn.classList.add('active');
            }
        });
        renderOffers();
    };

    const q = query(collection(db, "oferty"), orderBy("date", "desc"));
    
    onSnapshot(q, (snapshot) => {
        allOffers = [];
        snapshot.forEach(docSnap => {
            allOffers.push({ id: docSnap.id, ...docSnap.data() });
        });
        renderOffers();
    });

    function renderOffers() {
        const list = document.getElementById('offersList');
        list.innerHTML = "";
        
        const filtered = currentFilter === 'all' ? allOffers : allOffers.filter(o => o.type === currentFilter);

        if(filtered.length === 0) {
            list.innerHTML = `<div style="text-align:center; grid-column:1/-1; color:#666;">Brak ofert.</div>`;
            return;
        }

        filtered.forEach(data => {
            let tagClass = data.type; 
            let typeLabel = data.type.toUpperCase();
            
            let deleteBtn = "";
            if(currentUser && (data.userId === currentUser.uid || currentNick === "jacobpogorzelec")) {
                deleteBtn = `<button class="delete-btn" onclick="deleteOffer('${data.id}')">‚úï</button>`;
            }
            
            let imgHtml = data.img ? `<img src="${data.img}" class="item-img" onerror="this.style.display='none'">` : "";
            
            let sourceHtml = "";
            
            let cardClass = "offer-card legendary-item";

            if (data.source) {
                let mobIcon = data.sourceImg ? `<img src="${data.sourceImg}">` : "üï∑Ô∏è ";
                sourceHtml = `<div class="item-source">${mobIcon} <span>${data.source}</span></div>`;
            }
            
            let linkHtml = data.margoLink ? `<a href="${data.margoLink}" target="_blank" class="margo-link">üìä Statystyki</a>` : "";
            let timeAgo = timeSince(data.date);

            const html = `
                <div class="${cardClass}">
                    ${deleteBtn}
                    <div class="tag ${tagClass}">${typeLabel}</div>
                    ${imgHtml}
                    <div style="font-size:1.1em; font-weight:bold; margin-bottom:5px;">${data.name}</div>
                    ${sourceHtml}
                    ${linkHtml}
                    <div style="color:var(--gold-start); margin-bottom:10px;">Cena: ${data.price}</div>
                    <div style="color:#aaa; font-size:0.9em; margin-bottom:15px; font-style:italic;">${data.desc}</div>
                    
                    <div class="seller-info">
                        <div class="seller-left">
                            <img src="${data.avatar}" class="tiny-avatar">
                            <span style="color:#fff; font-weight:bold;">${data.nick}</span>
                            <button class="copy-nick-btn" onclick="copyNick('${data.nick}')">‚úâÔ∏è</button>
                        </div>
                        <div class="time-ago">${timeAgo}</div>
                    </div>
                </div>
            `;
            list.innerHTML += html;
        });
    }
</script>

</body>
</html>
