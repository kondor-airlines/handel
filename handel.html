<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Targowisko Klanowe</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #ffcc00;
            --google-blue: #4285F4;
            --bg: #121212;
            --card: #1e1e1e;
            --green: #2ecc71; --blue: #3498db; --red: #e74c3c;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg);
            color: #eee;
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        h1 {
            font-family: 'MedievalSharp', cursive;
            color: var(--gold);
            margin: 0;
            font-size: 2em;
        }

        /* LOGOWANIE */
        .login-btn {
            background-color: #fff;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.3s;
        }
        .login-btn:hover { background-color: #f1f1f1; }

        .user-profile {
            display: none;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--gold);
        }
        .logout-link { color: #888; font-size: 0.8em; text-decoration: underline; cursor: pointer; }

        /* FORMULARZ */
        .panel {
            background: var(--card);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
            margin-bottom: 30px;
            display: none; 
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        input, select, textarea {
            background: #000; border: 1px solid #444; color: white;
            padding: 10px; border-radius: 5px; width: 100%; box-sizing: border-box;
        }
        
        .full-width { grid-column: 1 / -1; }

        .action-btn {
            background: var(--gold); color: #000; border: none; padding: 12px;
            font-weight: bold; width: 100%; cursor: pointer; border-radius: 5px;
        }
        .action-btn:hover { background: #d4a000; }

        .search-row { display: flex; gap: 10px; align-items: center; }
        .search-btn { background: #444; color: #fff; border: 1px solid #555; padding: 10px; cursor: pointer; border-radius: 5px; white-space: nowrap; }

        /* LISTA OFERT */
        .offers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .offer-card {
            background: var(--card);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }

        .tag {
            display: inline-block; padding: 4px 8px; border-radius: 4px; 
            font-size: 0.8em; font-weight: bold; margin-bottom: 10px;
        }
        .tag.sprzedam { background: rgba(46, 204, 113, 0.2); color: var(--green); }
        .tag.kupie { background: rgba(52, 152, 219, 0.2); color: var(--blue); }
        .tag.zamienie { background: rgba(231, 76, 60, 0.2); color: var(--red); }

        .item-img { width: 50px; height: 50px; float: right; object-fit: contain; }
        .seller-info { 
            margin-top: 15px; padding-top: 10px; border-top: 1px solid #333; 
            display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: #aaa;
        }
        .tiny-avatar { width: 20px; height: 20px; border-radius: 50%; }

        .delete-btn {
            position: absolute; top: 10px; right: 10px;
            background: #333; color: #fff; border: none; cursor: pointer; font-size: 0.8em; padding: 2px 6px; border-radius: 3px;
        }
        .delete-btn:hover { background: red; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>‚öîÔ∏è Targowisko</h1>
        
        <button id="googleLoginBtn" class="login-btn">
            <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
            Zaloguj przez Google
        </button>

        <div id="userProfile" class="user-profile">
            <img id="userAvatar" class="user-avatar" src="" alt="">
            <div>
                <div id="userNickDisplay" style="font-weight:bold; color:var(--gold)">...</div>
                <div class="logout-link" onclick="logout()">Wyloguj</div>
            </div>
        </div>
    </header>

    <div id="addOfferPanel" class="panel">
        <h3 style="margin-top:0;">Dodaj og≈Çoszenie</h3>
        <div class="form-grid">
            <select id="offerType">
                <option value="sprzedam">Sprzedam</option>
                <option value="kupie">Kupiƒô</option>
                <option value="zamienie">Zamieniƒô</option>
            </select>
            <input type="text" id="itemPrice" placeholder="Cena (np. 50m)">
            
            <div class="search-row full-width">
                <input type="text" id="itemName" placeholder="Nazwa przedmiotu (dok≈Çadna)">
                <button class="search-btn" onclick="searchMargo()">üîç MargoWorld</button>
            </div>

            <input type="text" id="itemImg" placeholder="Link do obrazka (opcjonalne)" class="full-width">
            <textarea id="itemDesc" placeholder="Opis (statystyki, uwagi)" class="full-width"></textarea>
            
            <button class="action-btn full-width" onclick="addOffer()">DODAJ OFERTƒò</button>
        </div>
    </div>

    <h2 style="color:#aaa; border-bottom:1px solid #333; padding-bottom:10px;">Aktualne Oferty</h2>
    <div id="offersList" class="offers-grid">
        <div style="text-align:center; grid-column:1/-1;">≈Åadowanie...</div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // --- TU WKLEJ NOWƒÑ KONFIGURACJƒò FIREBASE (Tƒò Z PROJEKTU "TARGOWISKO") ---
const firebaseConfig = {
    apiKey: "AIzaSyApFYFkAghXreeX_xptg-PTCSxtPdiXYdA",
    authDomain: "targowisko-klanu.firebaseapp.com",
    projectId: "targowisko-klanu",
    storageBucket: "targowisko-klanu.firebasestorage.app",
    messagingSenderId: "1002027435908",
    appId: "1:1002027435908:web:56419c7bc38e148cf0ffd1"
  };
    // -----------------------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let currentNick = null;

    // --- LOGOWANIE GOOGLE + USTAWIANIE NICKU ---
    const loginBtn = document.getElementById('googleLoginBtn');
    
    loginBtn.addEventListener('click', () => {
        signInWithPopup(auth, provider).catch((error) => {
            alert("B≈ÇƒÖd: " + error.message);
        });
    });

    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (user) {
            // Sprawd≈∫ czy u≈ºytkownik ma ju≈º ustawiony nick w bazie
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                // Ma nick -> wczytaj go
                currentNick = userSnap.data().nick;
            } else {
                // Pierwsze logowanie -> zapytaj o nick
                let nick = prompt("Witaj nowy u≈ºytkowniku!\nPodaj sw√≥j dok≈Çadny nick z Margonem (to jednorazowe):");
                if(nick && nick.trim() !== "") {
                    currentNick = nick.trim();
                    await setDoc(userRef, {
                        nick: currentNick,
                        email: user.email,
                        photo: user.photoURL
                    });
                } else {
                    // Jak anulowa≈Ç, to wyloguj
                    alert("Musisz podaƒá nick, ≈ºeby korzystaƒá z targowiska.");
                    logout();
                    return;
                }
            }

            // Poka≈º panel
            document.getElementById('googleLoginBtn').style.display = 'none';
            document.getElementById('userProfile').style.display = 'flex';
            document.getElementById('addOfferPanel').style.display = 'block';
            
            document.getElementById('userNickDisplay').innerText = currentNick;
            document.getElementById('userAvatar').src = user.photoURL;
        } else {
            // Wylogowany
            document.getElementById('googleLoginBtn').style.display = 'flex';
            document.getElementById('userProfile').style.display = 'none';
            document.getElementById('addOfferPanel').style.display = 'none';
            currentNick = null;
        }
    });

    // --- OBS≈ÅUGA OFERT ---

    window.searchMargo = function() {
        const name = document.getElementById('itemName').value;
        if(!name) return alert("Wpisz nazwƒô!");
        window.open(`https://margoworld.pl/ladder/item?name=${encodeURIComponent(name)}`, '_blank');
    }

    window.addOffer = async function() {
        if (!currentUser || !currentNick) return alert("Musisz byƒá zalogowany i mieƒá nick!");

        const type = document.getElementById('offerType').value;
        const name = document.getElementById('itemName').value;
        const price = document.getElementById('itemPrice').value;
        const desc = document.getElementById('itemDesc').value;
        const img = document.getElementById('itemImg').value;

        if(!name || !price) return alert("Brakuje nazwy lub ceny!");

        try {
            await addDoc(collection(db, "oferty"), {
                userId: currentUser.uid, // Bezpieczne ID Google
                nick: currentNick,       // Nick z Margonem
                avatar: currentUser.photoURL,
                type, name, price, desc, img,
                date: new Date().toISOString()
            });
            
            // Wyczy≈õƒá
            document.getElementById('itemName').value = "";
            document.getElementById('itemPrice').value = "";
            document.getElementById('itemDesc').value = "";
            document.getElementById('itemImg').value = "";
        } catch(e) { alert("B≈ÇƒÖd: " + e.message); }
    }

    window.deleteOffer = async function(id) {
        if(confirm("UsunƒÖƒá og≈Çoszenie?")) await deleteDoc(doc(db, "oferty", id));
    }

    // ≈ÅADOWANIE
    const q = query(collection(db, "oferty"), orderBy("date", "desc"));
    
    onSnapshot(q, (snapshot) => {
        const list = document.getElementById('offersList');
        list.innerHTML = "";
        
        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id;
            
            let tagClass = data.type; 
            let typeLabel = data.type.toUpperCase();
            
            let deleteBtn = "";
            // Usuwaƒá mo≈ºe w≈Ça≈õciciel oferty LUB admin (czyli Ty - jacobpogorzelec)
            // Uwaga: Tutaj sprawdzamy nick zapisany w bazie
            if(currentUser && (data.userId === currentUser.uid || currentNick === "jacobpogorzelec")) {
                deleteBtn = `<button class="delete-btn" onclick="deleteOffer('${id}')">USU≈É</button>`;
            }

            let imgHtml = data.img ? `<img src="${data.img}" class="item-img" onerror="this.style.display='none'">` : "";

            const html = `
                <div class="offer-card">
                    ${deleteBtn}
                    <div class="tag ${tagClass}">${typeLabel}</div>
                    ${imgHtml}
                    <div style="font-size:1.1em; font-weight:bold; margin-bottom:5px;">${data.name}</div>
                    <div style="color:var(--gold); margin-bottom:10px;">${data.price}</div>
                    <div style="color:#aaa; font-size:0.9em; margin-bottom:15px; font-style:italic;">${data.desc}</div>
                    
                    <div class="seller-info">
                        <img src="${data.avatar}" class="tiny-avatar">
                        <span style="color:#fff; font-weight:bold;">${data.nick}</span>
                    </div>
                </div>
            `;
            list.innerHTML += html;
        });
        
        if(snapshot.empty) list.innerHTML = `<div style="text-align:center; grid-column:1/-1; color:#555;">Brak ofert.</div>`;
    });
</script>

</body>

</html>
